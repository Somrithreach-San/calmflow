<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- ✅ CRITICAL: Set theme from localStorage BEFORE CSS loads to prevent flash -->
    <script>
      (function () {
        try {
          const savedTheme = localStorage.getItem("theme");
          if (savedTheme) {
            document.documentElement.setAttribute("data-theme", savedTheme);
          }
        } catch (e) {
          console.log("Theme initialization error:", e);
        }
      })();
    </script>

    <title>Calm Flow</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='icons/favicon.png') }}"
    />
  </head>
  <body data-user-logged-in="{{ 'true' if user else 'false' }}">
    <div class="site-container">
      <header class="site-header">
        <div class="header-container">
          <a href="/" class="logo">Calm Flow</a>

          <!-- Global volume controls in header center -->
          <div class="header-center-controls">
            <div class="header-volume-controls">
              <img
                id="global-volume-icon"
                src="{{ url_for('static', filename='icons/volume.png') }}"
                alt="Volume"
                class="global-volume-icon"
              />
              <input
                id="global-volume"
                class="volume-slider global-slider"
                type="range"
                min="0"
                max="100"
                value="50"
              />
            </div>
          </div>

          <div class="header-controls">
            <button
              type="button"
              class="theme-toggle"
              id="theme-toggle"
              title="Toggle theme"
            >
              <img
                src="{{ url_for('static', filename='icons/sun.png') }}"
                alt="Sun"
                class="theme-icon sun"
              />
              <img
                src="{{ url_for('static', filename='icons/moon.png') }}"
                alt="Moon"
                class="theme-icon moon"
              />
            </button>

            <!-- User dropdown -->
            <div class="user-menu-container">
              <button class="user-menu-button" id="user-menu-button">
                <img
                  src="{{ url_for('static', filename='icons/user.png') }}"
                  alt="User"
                  class="user-icon"
                />
              </button>
              <div class="user-dropdown" id="user-dropdown">
                {% if user %}
                <!-- Logged in state - simple profile and logout -->
                <a href="{{ url_for('user_profile') }}" class="dropdown-item"
                  >Profile</a
                >
                <div class="dropdown-divider"></div>
                <a href="{{ url_for('logout') }}" class="dropdown-item"
                  >Logout</a
                >
                {% else %}
                <!-- Not logged in state - ONLY LOGIN -->
                <a href="{{ url_for('login') }}" class="dropdown-item">Login</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </header>

      <main class="main-content">
        <section class="playlists-section">
          <div class="playlists-header">
            <h2 class="section-title">Playlists</h2>

            <!-- ✅ MODIFIED: Create Playlist button for ALL users -->
            <!-- For logged-in users: normal button -->
            <!-- For non-logged-in users: grayed out with tooltip -->
            {% if user %}
            <button
              class="action-button create-playlist"
              id="create-playlist-btn"
            >
              Create Playlist
            </button>
            {% else %}
            <!-- FIXED: Wrapper with premium class for tooltip -->
            <div class="create-playlist-wrapper premium">
              <button
                class="action-button create-playlist disabled"
                id="create-playlist-btn"
                disabled
              >
                Create Playlist
              </button>
            </div>
            {% endif %}
          </div>

          <div class="carousel-wrapper">
            <button id="scroll-left" class="arrow-btn">&lt;</button>
            <div class="playlist-carousel-container">
              <div class="playlist-carousel">
                <div class="playlist-grid" id="playlist-grid">
                  <!-- Random playlist -->
                  <a href="#" class="playlist-card" id="random-playlist">
                    <div class="playlist-icon">
                      <img
                        src="{{ url_for('static', filename='icons/random.png') }}"
                        alt="Random Icon"
                        class="icon-img"
                      />
                    </div>
                    <h3 class="playlist-title">Random</h3>
                  </a>

                  <!-- Default group playlists -->
                  {% for group in groups %}
                  <a href="#" class="playlist-card" data-group="{{ group.id }}">
                    <div class="playlist-icon">
                      <img
                        src="{{ url_for('static', filename=group.playlist_icon.split('static/')[1] if 'static/' in group.playlist_icon else group.playlist_icon) }}"
                        alt="{{ group.name }} Icon"
                        class="icon-img"
                      />
                    </div>
                    <h3 class="playlist-title">{{ group.name }}</h3>
                  </a>
                  {% endfor %}
                  <!-- User playlists will be loaded here dynamically -->
                </div>
              </div>
            </div>
            <button id="scroll-right" class="arrow-btn">&gt;</button>
          </div>
        </section>

        <section class="sounds-section">
          <div class="sounds-header">
            <h2 class="section-title">Sounds</h2>
            <button class="action-button clear">Clear Playing</button>
          </div>
          <div class="sound-buttons-grid">
            {% for sound in sounds %} {% if sound.user_can_access %}
            <!-- Accessible sound (all for registered users, non-premium for guests) -->
            <div
              class="sound-button-container"
              data-sound-name="{{ sound['name'] }}"
              data-sound-id="{{ sound['id'] }}"
              data-group="{{ sound['groups'] | join(' ') }}"
            >
              <button class="sound-button">
                <img
                  src="{{ url_for('static', filename=sound['icon'].split('static/')[1] if 'static/' in sound['icon'] else sound['icon']) }}"
                  alt="{{ sound['display_name'] }}"
                  class="sound-icon"
                />
                <p class="sound-name">{{ sound['display_name'] }}</p>
              </button>
              <div class="volume-control hidden">
                <input
                  type="range"
                  class="volume-slider"
                  min="0"
                  max="100"
                  value="{{ (sound['default_volume'] * 100) | round|int if sound['default_volume'] else 50 }}"
                />
              </div>
              {% if user %}
              <!-- Add to playlist button (hidden by default, shown only in playlist creation mode) -->
              <button class="add-to-playlist-btn" title="Add to playlist">
                <img
                  src="{{ url_for('static', filename='icons/add.png') }}"
                  alt="Add"
                />
              </button>
              {% else %}
              <!-- Show locked add-to-playlist button for non-logged-in users -->
              <button
                class="add-to-playlist-btn disabled"
                title="Login Required"
              >
                <img
                  src="{{ url_for('static', filename='icons/add-locked.png') }}"
                  alt="Add"
                />
              </button>
              {% endif %}
            </div>
            {% else %}
            <!-- Premium sound (locked for non-logged-in users) -->
            <div class="sound-button-container premium">
              <button class="sound-button">
                <img
                  src="{{ url_for('static', filename=sound['icon'].split('static/')[1] if 'static/' in sound['icon'] else sound['icon']) }}"
                  alt="{{ sound['display_name'] }}"
                  class="sound-icon"
                />
                <p class="sound-name">{{ sound['display_name'] }}</p>
              </button>
              <div class="volume-control hidden">
                <input
                  type="range"
                  class="volume-slider"
                  min="0"
                  max="100"
                  value="50"
                />
              </div>
              <!-- Always show locked add button for premium sounds -->
              <button
                class="add-to-playlist-btn disabled"
                title="Login Required"
              >
                <img
                  src="{{ url_for('static', filename='icons/add-locked.png') }}"
                  alt="Add"
                />
              </button>
            </div>
            {% endif %} {% endfor %}
          </div>
        </section>
      </main>

      <footer class="site-footer">
        <p>&copy; Calm Flow.</p>
      </footer>
    </div>

    <!-- Create Playlist Modal - REMOVED ICON SELECTION -->
    <div id="create-playlist-modal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Create a new playlist</h2>
        <form id="create-playlist-form">
          <div class="form-group">
            <label for="playlist-name">Playlist Name</label>
            <input
              type="text"
              id="playlist-name"
              name="playlist_name"
              required
              placeholder="Playlist Name"
            />
          </div>
          <input
            type="hidden"
            id="playlist-icon"
            name="playlist_icon"
            value=""
          />
          <button type="submit" class="action-button">Create</button>
        </form>
      </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div id="add-to-playlist-modal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Add to Playlist</h2>
        <div id="user-playlists-list" class="empty-playlist">
          Loading playlists...
        </div>
      </div>
    </div>

    <!-- Toast messages for flash messages -->
    <div class="toast-container">
      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div class="toast toast-{{ category }}">
        <p class="toast-message">{{ message }}</p>
        <button class="toast-close">&times;</button>
      </div>
      {% endfor %} {% endif %} {% endwith %}
    </div>

    <!-- Delete Confirmation Modal -->
    <!-- Delete Confirmation Modal - Single Button (Normal Style) -->
    <div id="delete-confirmation-modal" class="modal">
      <div class="modal-content">
        <!-- X button for closing -->
        <button class="close-button">&times;</button>

        <div class="modal-body">
          <p class="warning-text">
            Are you sure you want to delete<span
              id="playlist-to-delete-name"
            ></span
            >?
          </p>
        </div>

        <div class="modal-footer">
          <!-- Single Delete button with normal styling -->
          <button class="btn" id="confirm-delete-btn">Delete</button>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
  </body>
</html>
